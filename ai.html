<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Endo Prism AI â€” Ultimate</title>
  <link rel="icon" href="/Favicon.png">
  <style>
    :root {
  --bg:#f4f6f8;
  --surface:#ffffff;
  --muted:#6b7280;
  --accent:#0066d6;
  --accent-2:#7c3aed;
  --ai:#002dc0;
  --user:#083269;
  --glass: rgba(255,255,255,0.6);
}

body.dark {
  --bg:#0b1220;
  --surface:#0f1724;
  --muted:#9ca3af;
  --accent:#2b6ef6;
  --accent-2:#8b5cf6;
  --ai:#0b1227;
  --user:#05203b;
  --glass: rgba(255,255,255,0.03);
  color: var(--muted);
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg, var(--bg), #e9eef7);
  color: #0f1724;
  display: flex;
  flex-direction: column;
}

header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: var(--surface);
  border-bottom: 1px solid rgba(15,23,34,0.06);
  box-shadow: 0 6px 30px rgba(2,6,23,0.04);
}

.brand { display: flex; gap: 12px; align-items: center; }
.logo { width: 44px; height: 44px; display: grid; place-items: center; border-radius: 10px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; font-weight: 700; }
.title { font-size: 1.05rem; font-weight: 700; }
.subtitle { font-size: .8rem; color: var(--muted); }
.controls { display: flex; gap: 8px; align-items: center; }
button.icon { background: transparent; border: 1px solid rgba(15,23,34,0.06); padding: 8px 10px; border-radius: 8px; cursor: pointer; }
button.primary { background: var(--accent); color: #fff; border: none; padding: 8px 12px; border-radius: 10px; }

/* MAIN GRID */
main {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 2fr 1fr; /* proportional widths */
  gap: 12px;
  padding: 12px;
  width: 100%;
  max-width: 100%;
}

/* Adjust proportions when left panel is hidden */
aside.panel:first-child {
  display: none; /* hidden by default */
}

/* All panels styling */
.panel {
  display: flex;
  flex-direction: column;
  background: var(--surface);
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 18px rgba(2,6,23,0.03);
  overflow: auto;
  transition: all 0.3s ease;
}

.panel h3 { margin: 0 0 10px 0; }
.info-list { display: flex; flex-direction: column; gap: 8px; }
.info-item { display: flex; justify-content: space-between; gap: 8px; padding: 10px; border-radius: 8px; background: var(--glass); }
.info-item small { color: var(--muted); }
.mem-list { display: flex; flex-direction: column; gap: 8px; max-height: 320px; overflow: auto; }

/* CHAT STYLING */
.chat-window {
  display: flex;
  flex-direction: column;
  gap: 10px;
  height: calc(100vh - 160px);
}

.messages {
  flex: 1;
  overflow: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.msg {
  max-width: 78%;
  padding: 12px 14px;
  border-radius: 14px;
  line-height: 1.45;
  white-space: pre-wrap;
}

.msg.user { align-self: flex-end; background: var(--user); color: var(--surface); border-bottom-right-radius: 6px; }
.msg.ai { align-self: flex-start; background: var(--ai); color: var(--surface); border-bottom-left-radius: 6px; }

.meta { font-size: .78rem; color: var(--muted); margin-bottom: 6px; }

.composer {
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 10px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.5));
  border: 1px solid rgba(15,23,34,0.04);
}

.composer input,
.composer textarea {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(15,23,34,0.06);
  background: transparent;
}

.composer textarea { min-height: 64px; resize: vertical; }
.quick-actions { display: flex; gap: 6px; }

/* RIGHT PANEL TOOLS */
.tools {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.tool { padding: 12px; border-radius: 10px; background: var(--surface); }

pre.code { background: #0b1220; color: #dbeafe; padding: 12px; border-radius: 8px; overflow: auto; }

footer {
  padding: 12px 18px;
  text-align: center;
  font-size: .85rem;
  color: var(--muted);
  background: transparent;
}

/* RESPONSIVE */
@media (max-width: 1100px) {
  main {
    grid-template-columns: 1fr; /* stack vertically */
  }
  .tools { display: none; }
  .panel { display: none; }
}


  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">E.P.</div>
      <div>
        <div class="title">Endo Prism AI â€” Ultimate</div>
        <div class="subtitle">Local-first knowledge â€¢ Website generator â€¢ Search fallbacks</div>
      </div>
    </div>

    <div class="controls">
      <button id="btnReset" class="icon" title="Reset memory">Reset</button>
      <button id="btnExport" class="icon" title="Export conversation">Export</button>
      <button id="toggleDark" class="icon" title="Toggle theme">ðŸŒ™</button>
      <button id="btnAbout" class="primary">About</button>
    </div>
  </header>

  <main>
    <aside class="panel">
      
      <hr style="margin:12px 0; border:none; border-top:1px solid rgba(15,23,34,0.04)">

      <h3>Memory</h3>
      <div class="mem-list" id="memList"><small>No memories yet.</small></div>

      <hr style="margin:12px 0; border:none; border-top:1px solid rgba(15,23,34,0.04)">

      <h3>Quick Prompts</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="icon" data-prompt="make a website about electric cars">Website: Electric cars</button>
        <button class="icon" data-prompt="search climate change summary">Search: Climate</button>
        <button class="icon" data-prompt="tell me about sydney opera house">Define: Sydney</button>
        <br>
        <br>
      </div>
      <h3>Knowledge</h3>
<div id="knowledgeArea">
  <small style="color:var(--muted)">Loading local knowledgeâ€¦</small>
</div>
    </aside>

    <section class="chat-window panel">
      <div class="meta">Conversation</div>
      <div class="messages" id="messages"></div>

      <div class="composer">
        <textarea id="userInput" placeholder="Type your message â€” try: 'make a website about x' or 'search <topic>'"></textarea>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div style="display:flex; gap:8px; flex-direction:column">
            <button id="sendBtn" class="primary">Send</button>
            <button id="btnGen" class="icon" title="Generate website from last topic">Generate Site</button>
          </div>
        </div>
      </div>
    </section>

    <aside class="panel tools">
      <div class="tool">
        <h4>Actions</h4>
        <div style="display:flex; gap:8px; flex-direction:column">
          <button id="btnSearch" class="icon">Run Web Search</button>
          <button id="btnSumm" class="icon">Summarize Last</button>
          <button id="btnSaveMem" class="icon">Save to Memory</button>
        </div>
      </div>

      <div class="tool">
        <h4>Generated Code</h4>
        <div id="generatedCodePreview"><small>No generated site yet.</small></div>
      </div>

      <div class="tool">
        <h4>Dev Notes</h4>
        <small style="color:var(--muted)">This single-file app is intentionally local-first. Web search will attempt CORS-friendly APIs (Wikipedia) and graceful fallbacks. To enable server-side scraping or proper search results use a small server proxy (instructions in About).</small>
      </div>
    </aside>
  </main>

  <footer>
    Â© Endo Prism AI â€” Ultimate â€¢ (1.0012)
  </footer>

  <script>
  /* =========== Endo Prism AI â€” Ultimate (single-file) ==================
     Features included:
      - info.json local knowledge loader
      - memory stored in localStorage
      - intent detector (search / build website / define / convo)
      - website generator (clean template)
      - Wikipedia REST fallback and graceful messages
      - UI: export, reset, theme toggle, copy code
     =====================================================================*/

  // Utilities
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const messages = $('#messages');
  const userInput = $('#userInput');
  const sendBtn = $('#sendBtn');
  const toggleDark = $('#toggleDark');
  const knowledgeArea = $('#knowledgeArea');
  const memList = $('#memList');
  const generatedCodePreview = $('#generatedCodePreview');

  // State
  const state = {
    memories: JSON.parse(localStorage.getItem('ep_memories')||'[]'),
    theme: localStorage.getItem('ep_theme') || 'light',
    lastTopic: '',
    localKnowledge: {}
  };

  // Initialize theme
  if(state.theme === 'dark') document.body.classList.add('dark');
  function toggleTheme(){ document.body.classList.toggle('dark'); state.theme = document.body.classList.contains('dark') ? 'dark' : 'light'; localStorage.setItem('ep_theme', state.theme); }
  toggleDark.addEventListener('click', toggleTheme);

  // Helpers for messages
  function appendMessage(text, sender='ai', meta=''){
    const el = document.createElement('div'); el.className = 'msg ' + (sender==='user'?'user':'ai');
    if(meta) {
      const m = document.createElement('div'); m.className='meta'; m.textContent = meta; el.appendChild(m);
    }
    const t = document.createElement('div'); t.textContent = text; el.appendChild(t);
    messages.appendChild(el);
    messages.scrollTop = messages.scrollHeight;
    return el;
  }

  // Load local info.json
  async function loadLocalKnowledge(){
    knowledgeArea.innerHTML = 'Loading local knowledge...';
    try{
      const res = await fetch('info.json');
      if(!res.ok) throw new Error('No info.json');
      const obj = await res.json();
      state.localKnowledge = obj;
      renderKnowledge(obj);
    } catch(err){
      knowledgeArea.innerHTML = '<small style="color:var(--muted)">No info.json found. Place a JSON file named <code>info.json</code> next to this HTML. Example structure available in About.</small>';
    }
  }

  function renderKnowledge(obj){
    knowledgeArea.innerHTML = '';
    if(!obj || Object.keys(obj).length===0){ knowledgeArea.innerHTML = '<small>No local data found.</small>'; return }
    for(const key of Object.keys(obj)){
      const item = document.createElement('div'); item.className='info-item';
      const left = document.createElement('div'); left.innerHTML = `<strong>${key}</strong><br><small>${String(obj[key].summary || obj[key]).slice(0,120)}</small>`;
      const right = document.createElement('div');
      const btn = document.createElement('button'); btn.className='icon'; btn.textContent='Insert';
      btn.onclick = ()=>{ userInput.value = `tell me about ${key}`; userInput.focus(); };
      right.appendChild(btn);
      item.appendChild(left); item.appendChild(right);
      knowledgeArea.appendChild(item);
    }
  }

  // Memory
  function persistMemories(){ localStorage.setItem('ep_memories', JSON.stringify(state.memories)); renderMemories(); }
  function renderMemories(){ memList.innerHTML=''; if(state.memories.length===0){ memList.innerHTML='<small>No memories yet.</small>'; return }
    state.memories.slice().reverse().forEach((m,i)=>{
      const div = document.createElement('div'); div.className='info-item'; div.innerHTML = `<div><strong>${m.title}</strong><br><small>${m.text.slice(0,90)}</small></div><div><button class='icon' data-idx='${i}'>Use</button></div>`;
      memList.appendChild(div);
    });
    // wire use buttons
    $$('.info-item button.icon').forEach(b=>b.addEventListener('click', e=>{ const i = +e.currentTarget.dataset.idx; userInput.value = state.memories[state.memories.length-1-i].text; userInput.focus(); }));
  }

  // Intent detection (simple but extensible)
  function detectIntent(text){
    const t = text.trim().toLowerCase();
    if(/^search\s+/.test(t)) return {intent:'search', q:t.replace(/^search\s+/,'')};
    if(/make .*website|build .*website|generate .*website/.test(t)) return {intent:'build', q:t.replace(/.*website.*about\s*/,'').trim() || t};
    if(/^what is|^who is|tell me about|^define\s+/.test(t)) return {intent:'define', q:t.replace(/^(what is|who is|tell me about|define)\s+/,'')};
    if(/^save memory\s*/.test(t)) return {intent:'save'};
    return {intent:'chat', q:t};
  }

  // Website generator
  function generateWebsite(topic, infoText){
    const title = topic || 'My Website';
    const html = `<!doctype html>\n<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${escapeHtml(title)}</title>\n<style>body{font-family:Inter,system-ui,sans-serif;padding:24px;line-height:1.6;color:#0f1724}h1{color:${state.theme==='dark'?'#dbeafe':'#0066d6'}}</style></head><body><h1>${escapeHtml(title)}</h1><p>${escapeHtml(infoText)}</p><\/body><\/html>`;
    generatedCodePreview.innerHTML = '';
    const pre = document.createElement('pre'); pre.className='code'; pre.textContent = html;
    const btn = document.createElement('button'); btn.className='icon'; btn.textContent='Copy HTML'; btn.onclick = ()=>{ navigator.clipboard.writeText(html); btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy HTML',1400)};
    generatedCodePreview.appendChild(pre); generatedCodePreview.appendChild(btn);
  }

  // small escape
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

  // Web search using local knowledge first, then Wikipedia REST
async function webSearch(query){
  const key = query.toLowerCase();

  // 1ï¸âƒ£ Check local knowledge
  const local = findLocal(key);
  if(local) {
    const out = `ðŸ’¾ Local knowledge for "${query}":\n\n${local.summary || JSON.stringify(local)}`;
    appendMessage(out,'ai','local');
    return out;
  }

  appendMessage(`ðŸ”Ž Searching web for: ${query}`,'ai');

  // 2ï¸âƒ£ Wikipedia REST API (CORS-enabled)
  try{
    const q = encodeURIComponent(query.trim());
    const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${q}`;
    const res = await fetch(url);
    if(res.ok){
      const data = await res.json();
      if(data.extract){
        const out = `ðŸ“˜ Wikipedia summary for "${data.title}":\n\n${data.extract}`;
        appendMessage(out,'ai','search result');
        return out;
      }
    }
  }catch(e){
    console.warn('Wikipedia fetch failed:', e);
  }

  // 3ï¸âƒ£ Fallback
  const fallback = `âŒ No information found for "${query}". Try a different search or add it to info.json.`;
  appendMessage(fallback,'ai','fallback');
  return fallback;
}


  // Handle AI-like response (simple local heuristics + webSearch)
  async function handleAI(text){
    const it = detectIntent(text);
    switch(it.intent){
      case 'search': {
        const res = await webSearch(it.q);
        state.lastTopic = it.q;
        appendMessage(res,'ai', 'search result');
        return res;
      }
      case 'define': {
        // check local knowledge first
        const key = it.q.toLowerCase();
        const local = findLocal(key);
        if(local){ const out = `ðŸ’¾ Local: ${key}\n\n${local.summary || JSON.stringify(local)}`; appendMessage(out,'ai','local'); state.lastTopic = key; return out; }
        const res = await webSearch(it.q);
        state.lastTopic = it.q; appendMessage(res,'ai','define'); return res;
      }
      case 'build': {
        const topic = it.q || state.lastTopic || 'My Topic';
        const info = await webSearch(topic);
        const html = generateWebsite(topic, info);
        appendMessage('âœ… Website generated â€” preview on the right.', 'ai','generator');
        return html; // note: we also render in generatedCodePreview via generateWebsite
      }
      case 'save': {
        const title = prompt('Memory title?') || new Date().toLocaleString();
        state.memories.push({title, text: text}); persistMemories(); appendMessage('Saved to memory: '+title,'ai'); return 'saved';
      }
      default: {
        // conversational fallback â€” respond with helpful nudges
        const local = findLocal(it.q);
        if(local){ const o = `${local.summary || JSON.stringify(local)}`; appendMessage(o,'ai','local'); return o; }
        appendMessage('Hmm - I have not found that in my databaseâ—ï¸ If this happens again, use the search feature ðŸ”Ž  "search {topic}"','ai');
        return null;
      }
    }
  }

  function findLocal(query){
    if(!query) return null;
    const k = Object.keys(state.localKnowledge||{}).find(k=>k.toLowerCase()===query.toLowerCase());
    return k ? state.localKnowledge[k] : null;
  }

  // UI events
  sendBtn.addEventListener('click', async ()=>{ const txt = userInput.value.trim(); if(!txt) return; appendMessage(txt,'user'); userInput.value=''; await handleAI(txt); persistMemories(); });
  userInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

  // quick prompts
  $$('.panel button.icon[data-prompt]').forEach(b=>b.addEventListener('click', e=>{ userInput.value = e.currentTarget.dataset.prompt; userInput.focus(); }));

  // generate website from last topic
  $('#btnGen').addEventListener('click', async ()=>{
    const topic = state.lastTopic || prompt('Topic for website:') || 'My Topic';
    const info = await webSearch(topic);
    generateWebsite(topic, info);
  });

  // other tools
  $('#btnSearch').addEventListener('click', ()=>{ const q = prompt('Search query:'); if(q) { userInput.value = 'search '+q; sendBtn.click(); } });
  $('#btnSumm').addEventListener('click', async ()=>{ const last = state.lastTopic || prompt('Topic to summarize:'); if(!last) return; const s = await webSearch(last); appendMessage(s,'ai','summary'); });
  $('#btnSaveMem').addEventListener('click', ()=>{ const txt = userInput.value.trim() || prompt('Text to save to memory:'); if(!txt) return; const title = prompt('Memory title?') || txt.slice(0,30); state.memories.push({title, text:txt}); persistMemories(); appendMessage('Saved memory: '+title,'ai'); });

  $('#btnReset').addEventListener('click', ()=>{ if(confirm('Reset memories and local state?')){ state.memories=[]; persistMemories(); localStorage.removeItem('ep_theme'); location.reload(); } });

  $('#btnExport').addEventListener('click', ()=>{
    const data = {memories:state.memories, localKnowledge:state.localKnowledge};
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'endo-prism-export.json'; a.click(); URL.revokeObjectURL(url);
  });

  $('#btnAbout').addEventListener('click', ()=>{
    alert('Endo Prism AI â€” Ultimate\n\nThis single-file project is local-first: drop an info.json next to this file to enable local knowledge. Web search uses Wikipedia REST and a relaxed proxy method. For full web scraping or real search results, run a tiny server-side proxy.\n\nSample info.json is shown in the console.');
    console.info('SAMPLE info.json:\n', JSON.stringify({"Endo Prism AI":{summary:'An experimental local knowledge entry.', version:'1.0.0'}, "Pieter Tschopp":{summary:'Contributor to the project.'}}, null,2));
  });

  // load on start
  (async ()=>{ await loadLocalKnowledge(); renderMemories(); appendMessage("ðŸ‘‹ Hello! I'm Endo Prism AI â€” Ultimate. Try: 'search climate change' or 'make a website about tesla'",'ai'); })();

  </script>
</body>
</html>
